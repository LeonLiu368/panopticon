{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/leonliu/projects/tartanhacks/lib/supabase-client.ts"],"sourcesContent":["// Lightweight in-memory Supabase mock so the app runs with zero external services.\n// Supports the minimal chainable API surface we use in the UI and route handlers.\n\ntype TableName =\n  | 'incidents'\n  | 'police_stations'\n  | 'units'\n  | 'dispatches'\n  | 'checkpoints'\n  | 'unit_stats';\n\n// Seed data for local/offline demo\nconst db: Record<TableName, any[]> = {\n  incidents: [\n    {\n      id: 'robbery-forbes-morewood',\n      name: 'Robbery at Forbes & Morewood',\n      status: 'active',\n      priority: 'high',\n      risk: 'high',\n      lat: 40.4427,\n      lon: -79.9425,\n      containment: 15,\n      description: 'Reported robbery near CMU campus',\n      incident_type: 'robbery',\n      start_time: new Date().toISOString(),\n      last_update: new Date().toISOString(),\n      reported_by: 'Dispatch',\n    },\n    {\n      id: 'traffic-cmu',\n      name: 'Multi-vehicle collision on Fifth Ave',\n      status: 'active',\n      priority: 'medium',\n      risk: 'medium',\n      lat: 40.4433,\n      lon: -79.9490,\n      containment: 35,\n      description: '3-car collision blocking two lanes',\n      incident_type: 'traffic',\n      start_time: new Date().toISOString(),\n      last_update: new Date().toISOString(),\n      reported_by: '911',\n    },\n  ],\n  police_stations: [\n    { id: 1, name: 'Station 1 - Downtown', city: 'Pittsburgh', county: 'Allegheny', lat: 40.4406, lon: -79.9959, created_at: new Date().toISOString() },\n    { id: 2, name: 'Station 2 - North', city: 'Pittsburgh', county: 'Allegheny', lat: 40.4500, lon: -79.9500, created_at: new Date().toISOString() },\n    { id: 3, name: 'Station 3 - South', city: 'Pittsburgh', county: 'Allegheny', lat: 40.4300, lon: -79.9800, created_at: new Date().toISOString() },\n  ],\n  units: [],\n  dispatches: [],\n  checkpoints: [],\n  unit_stats: [],\n};\n\n// Create three units per station\ndb.police_stations.forEach((station) => {\n  Array.from({ length: 3 }).forEach((_, idx) => {\n    db.units.push({\n      id: `${station.id}-unit-${idx + 1}`,\n      station_id: station.id,\n      unit_number: `Unit ${station.id}-${idx + 1}`,\n      unit_type: idx === 2 ? 'k9' : 'patrol',\n      status: 'available',\n      current_lat: station.lat,\n      current_lon: station.lon,\n      incident_id: null,\n      dispatched_at: null,\n      arrived_at: null,\n      created_at: new Date().toISOString(),\n      updated_at: new Date().toISOString(),\n    });\n  });\n});\n\n// Extra pre-positioned patrols around CMU / Oakland for demo visibility\ndb.units.push(\n  {\n    id: 'patrol-cmu-1',\n    station_id: 1,\n    unit_number: 'Patrol CMU-1',\n    unit_type: 'patrol',\n    status: 'available',\n    current_lat: 40.4445,\n    current_lon: -79.9432,\n    incident_id: null,\n    dispatched_at: null,\n    arrived_at: null,\n    created_at: new Date().toISOString(),\n    updated_at: new Date().toISOString(),\n  },\n  {\n    id: 'traffic-forbes-1',\n    station_id: 1,\n    unit_number: 'Traffic Forbes',\n    unit_type: 'traffic',\n    status: 'available',\n    current_lat: 40.4429,\n    current_lon: -79.9418,\n    incident_id: null,\n    dispatched_at: null,\n    arrived_at: null,\n    created_at: new Date().toISOString(),\n    updated_at: new Date().toISOString(),\n  },\n  {\n    id: 'k9-shadyside',\n    station_id: 2,\n    unit_number: 'K9 Shadyside',\n    unit_type: 'k9',\n    status: 'available',\n    current_lat: 40.4545,\n    current_lon: -79.9320,\n    incident_id: null,\n    dispatched_at: null,\n    arrived_at: null,\n    created_at: new Date().toISOString(),\n    updated_at: new Date().toISOString(),\n  }\n);\n\n// Helper to compute unit_stats view on the fly\nconst computeUnitStats = () => {\n  return db.police_stations.map((ps) => {\n    const units = db.units.filter((u) => u.station_id === ps.id);\n    return {\n      station_id: ps.id,\n      station_name: ps.name,\n      available_units: units.filter((u) => u.status === 'available').length,\n      dispatched_units: units.filter((u) => ['dispatched', 'en_route'].includes(u.status)).length,\n      on_scene_units: units.filter((u) => u.status === 'on_scene').length,\n      total_units: units.length,\n    };\n  });\n};\n\n// Utility clone\nconst clone = <T>(v: T): T => JSON.parse(JSON.stringify(v));\n\n// Reset mock state to initial availability (useful on app load/hot reload)\nexport const resetMockState = () => {\n  db.units = db.units.map((u) => ({\n    ...u,\n    status: 'available',\n    incident_id: null,\n    dispatched_at: null,\n    arrived_at: null,\n    updated_at: new Date().toISOString(),\n  }));\n  db.dispatches = [];\n};\n\n// Query builder\nfunction buildSelect(table: TableName, rows: any[]) {\n  let working = [...rows];\n\n  const api: any = {\n    select: (_cols: string = '*') => api,\n    eq: (col: string, val: any) => {\n      working = working.filter((r) => r[col] === val);\n      return api;\n    },\n    in: (col: string, vals: any[]) => {\n      working = working.filter((r) => vals.includes(r[col]));\n      return api;\n    },\n    order: (col: string, opts: { ascending?: boolean } = {}) => {\n      const asc = opts.ascending !== false;\n      working = [...working].sort((a, b) => {\n        if (a[col] === b[col]) return 0;\n        return (a[col] > b[col] ? 1 : -1) * (asc ? 1 : -1);\n      });\n      return api;\n    },\n    limit: (n: number) => {\n      working = working.slice(0, n);\n      return Promise.resolve({ data: clone(working), error: null });\n    },\n    then: (resolve: any, reject: any) =>\n      Promise.resolve({ data: clone(working), error: null }).then(resolve, reject),\n  };\n\n  return api;\n}\n\nfunction buildUpdate(table: TableName, values: Record<string, any>) {\n  return {\n    eq: (col: string, val: any) => {\n      const updated: any[] = [];\n      db[table] = db[table].map((row) => {\n        if (row[col] === val) {\n          const next = { ...row, ...values, updated_at: new Date().toISOString() };\n          updated.push(next);\n          return next;\n        }\n        return row;\n      });\n      return Promise.resolve({ data: clone(updated), error: null });\n    },\n    in: (col: string, vals: any[]) => {\n      const updated: any[] = [];\n      db[table] = db[table].map((row) => {\n        if (vals.includes(row[col])) {\n          const next = { ...row, ...values, updated_at: new Date().toISOString() };\n          updated.push(next);\n          return next;\n        }\n        return row;\n      });\n      return Promise.resolve({ data: clone(updated), error: null });\n    },\n  };\n}\n\nfunction buildInsert(table: TableName, payload: any | any[]) {\n  const items = Array.isArray(payload) ? payload : [payload];\n  const withIds = items.map((item) => ({\n    ...item,\n    id: item.id || crypto.randomUUID?.() || `id-${Math.random().toString(36).slice(2, 8)}`,\n    created_at: new Date().toISOString(),\n    updated_at: new Date().toISOString(),\n  }));\n  db[table].push(...withIds);\n  return Promise.resolve({ data: clone(withIds), error: null });\n}\n\nfunction buildDelete(table: TableName) {\n  return {\n    eq: (col: string, val: any) => {\n      const removed = db[table].filter((row) => row[col] === val);\n      db[table] = db[table].filter((row) => row[col] !== val);\n      return Promise.resolve({ data: clone(removed), error: null });\n    },\n  };\n}\n\nconst mockChannel = () => {\n  const ch: any = {\n    on: () => ch,\n    subscribe: () => ch,\n    unsubscribe: () => {},\n  };\n  return ch;\n};\n\nexport const supabase: any = {\n  from: (table: TableName) => {\n    if (table === 'unit_stats') {\n      return buildSelect(table, computeUnitStats());\n    }\n    return {\n      select: (_cols: string = '*') => buildSelect(table, db[table]),\n      update: (values: Record<string, any>) => buildUpdate(table, values),\n      insert: (payload: any | any[]) => buildInsert(table, payload),\n      delete: () => buildDelete(table),\n    };\n  },\n  channel: (_name: string) => mockChannel(),\n  removeChannel: (_ch: any) => {},\n  // Expose db for debugging in dev tools\n  __data: db,\n  // Helper to mutate units in-memory (used by animations)\n  __updateUnitPosition: (id: string, lat: number, lon: number, status?: string) => {\n    db.units = db.units.map((u) =>\n      u.id === id\n        ? {\n            ...u,\n            current_lat: lat,\n            current_lon: lon,\n            status: status || u.status,\n            updated_at: new Date().toISOString(),\n          }\n        : u\n    );\n  },\n};\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 356, "column": 0}, "map": {"version":3,"sources":["file:///Users/leonliu/projects/tartanhacks/app/api/dispatch-unit/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { supabase } from '@/lib/supabase-client';\n\n// Calculate distance between two points using Haversine formula (in kilometers)\nfunction calculateDistance(lat1: number, lon1: number, lat2: number, lon2: number): number {\n  const R = 6371; // Earth's radius in km\n  const dLat = (lat2 - lat1) * Math.PI / 180;\n  const dLon = (lon2 - lon1) * Math.PI / 180;\n  const a = \n    Math.sin(dLat / 2) * Math.sin(dLat / 2) +\n    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *\n    Math.sin(dLon / 2) * Math.sin(dLon / 2);\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n  return R * c;\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { incidentId, incidentLat, incidentLon } = body;\n\n    console.log('[DISPATCH] Received request:', { incidentId, incidentLat, incidentLon });\n\n    if (!incidentId || !incidentLat || !incidentLon) {\n      console.error('[DISPATCH] Missing required fields');\n      return NextResponse.json(\n        { error: 'Missing required fields: incidentId, incidentLat, incidentLon' },\n        { status: 400 }\n      );\n    }\n\n    // Get all police stations\n    const { data: stations, error: stationsError } = await supabase\n      .from('police_stations')\n      .select('*');\n\n    console.log('[DISPATCH] Fetched police stations:', stations?.length || 0);\n\n    if (stationsError || !stations) {\n      console.error('[DISPATCH] Failed to fetch police stations:', stationsError);\n      return NextResponse.json(\n        { error: 'Failed to fetch police stations', details: stationsError?.message },\n        { status: 500 }\n      );\n    }\n\n    // Find nearest station with available units\n    let nearestStation = null;\n    let minDistance = Infinity;\n\n    for (const station of stations) {\n      const distance = calculateDistance(incidentLat, incidentLon, station.lat, station.lon);\n      \n      // Check if station has available units\n      const { data: availableUnits } = await supabase\n        .from('units')\n        .select('*')\n        .eq('station_id', station.id)\n        .eq('status', 'available')\n        .limit(1);\n\n      if (availableUnits && availableUnits.length > 0 && distance < minDistance) {\n        nearestStation = station;\n        minDistance = distance;\n      }\n    }\n\n    if (!nearestStation) {\n      console.error('[DISPATCH] No available units found');\n      return NextResponse.json(\n        { error: 'No available units found', message: 'All units are currently dispatched' },\n        { status: 404 }\n      );\n    }\n\n    console.log('[DISPATCH] Nearest station:', nearestStation.name, 'Distance:', minDistance.toFixed(2), 'km');\n\n    // Get an available unit from the nearest station\n    const { data: availableUnits } = await supabase\n      .from('units')\n      .select('*')\n      .eq('station_id', nearestStation.id)\n      .eq('status', 'available')\n      .order('unit_number', { ascending: true })\n      .limit(1);\n\n    console.log('[DISPATCH] Available units at nearest station:', availableUnits?.length || 0);\n\n    if (!availableUnits || availableUnits.length === 0) {\n      return NextResponse.json(\n        { error: 'No available units at nearest station' },\n        { status: 404 }\n      );\n    }\n\n    const unit = availableUnits[0];\n\n    console.log('[DISPATCH] Dispatching', unit.unit_number, 'from', nearestStation.name);\n\n    // Update unit status to dispatched\n    const { error: updateError } = await supabase\n      .from('units')\n      .update({\n        status: 'dispatched',\n        incident_id: incidentId,\n        dispatched_at: new Date().toISOString(),\n        current_lat: nearestStation.lat,\n        current_lon: nearestStation.lon,\n        updated_at: new Date().toISOString()\n      })\n      .eq('id', unit.id);\n\n    if (updateError) {\n      console.error('[DISPATCH] Failed to update unit:', updateError);\n      return NextResponse.json(\n        { error: 'Failed to dispatch unit', details: updateError.message },\n        { status: 500 }\n      );\n    }\n\n    // Create dispatch record\n    const { error: dispatchError } = await supabase\n      .from('dispatches')\n      .insert({\n        incident_id: incidentId,\n        unit_id: unit.id,\n        status: 'assigned',\n        assigned_at: new Date().toISOString()\n      });\n\n    if (dispatchError) {\n      console.error('[DISPATCH] Failed to create dispatch record:', dispatchError);\n    }\n\n    console.log('[DISPATCH] âœ… Successfully dispatched', unit.unit_number);\n\n    // Fetch route from Mapbox Directions API\n    // ---- Route + ETA calculation (offline friendly) ----\n    // Try Mapbox first; fallback to straight-line estimate if it fails.\n    const mapboxToken = process.env.NEXT_PUBLIC_MAPBOX_TOKEN || null;\n    let route: any = null;\n    let estimatedDuration = 0;\n\n    const straightLineDistanceKm = calculateDistance(\n      nearestStation.lat,\n      nearestStation.lon,\n      incidentLat,\n      incidentLon\n    );\n\n    const fallbackGeometry = {\n      type: 'LineString',\n      coordinates: [\n        [nearestStation.lon, nearestStation.lat],\n        [incidentLon, incidentLat],\n      ],\n    };\n\n    try {\n      if (mapboxToken) {\n        const routeUrl = `https://api.mapbox.com/directions/v5/mapbox/driving/${nearestStation.lon},${nearestStation.lat};${incidentLon},${incidentLat}?geometries=geojson&access_token=${mapboxToken}`;\n        const routeResponse = await fetch(routeUrl);\n        const routeData = await routeResponse.json();\n        if (routeData.routes && routeData.routes.length > 0) {\n          route = routeData.routes[0];\n          estimatedDuration = route.duration;\n        } else {\n          throw new Error('No routes returned');\n        }\n      } else {\n        throw new Error('No Mapbox token; using fallback');\n      }\n    } catch (err) {\n      // Fallback: assume 60 km/h average speed\n      const avgSpeedKmH = 60;\n      estimatedDuration = (straightLineDistanceKm / avgSpeedKmH) * 3600;\n      route = {\n        geometry: fallbackGeometry,\n        distance: straightLineDistanceKm * 1000,\n        duration: estimatedDuration,\n      };\n    }\n\n    // Update dispatch with route and ETA\n    if (!dispatchError) {\n      await supabase\n        .from('dispatches')\n        .update({\n          eta_seconds: estimatedDuration,\n          route_geometry: route.geometry,\n          status: 'en_route'\n        })\n        .eq('incident_id', incidentId)\n        .eq('unit_id', unit.id);\n    }\n\n    return NextResponse.json({\n      success: true,\n      unit: {\n        id: unit.id,\n        station_id: unit.station_id,\n        station_name: nearestStation.name,\n        unit_number: unit.unit_number,\n        unit_type: unit.unit_type,\n        incident_id: incidentId,\n        dispatched_at: new Date().toISOString(),\n        estimated_arrival: new Date(Date.now() + estimatedDuration * 1000).toISOString(),\n        estimated_duration: estimatedDuration\n      },\n      route: {\n        geometry: route.geometry,\n        distance: route.distance, // in meters\n        duration: route.duration // in seconds\n      },\n      station: {\n        lat: nearestStation.lat,\n        lon: nearestStation.lon,\n        name: nearestStation.name\n      },\n      incident: {\n        lat: incidentLat,\n        lon: incidentLon\n      }\n    });\n  } catch (error) {\n    console.error('Dispatch unit error:', error);\n    return NextResponse.json(\n      { error: 'Internal server error', details: error instanceof Error ? error.message : 'Unknown error' },\n      { status: 500 }\n    );\n  }\n}\n\n// GET endpoint to fetch unit statistics\nexport async function GET(request: NextRequest) {\n  try {\n    const { data: stats, error } = await supabase\n      .from('unit_stats')\n      .select('*');\n\n    if (error) {\n      return NextResponse.json(\n        { error: 'Failed to fetch unit stats', details: error.message },\n        { status: 500 }\n      );\n    }\n\n    // Get all units (available + active) so UI can display every car\n    const { data: activeUnits, error: activeError } = await supabase\n      .from('units')\n      .select(`\n        *,\n        incidents (*),\n        police_stations (name, city, county)\n      `);\n\n    if (activeError) {\n      return NextResponse.json(\n        { error: 'Failed to fetch active units', details: activeError.message },\n        { status: 500 }\n      );\n    }\n\n    // Calculate totals\n    const totalAvailable = stats?.reduce((sum, s) => sum + (s.available_units || 0), 0) || 0;\n    const totalDispatched = stats?.reduce((sum, s) => sum + (s.dispatched_units || 0), 0) || 0;\n    const totalOnScene = stats?.reduce((sum, s) => sum + (s.on_scene_units || 0), 0) || 0;\n    const totalUnits = stats?.reduce((sum, s) => sum + (s.total_units || 0), 0) || 0;\n\n    return NextResponse.json({\n      stats: stats || [],\n      activeUnits: activeUnits || [],\n      totals: {\n        available: totalAvailable,\n        dispatched: totalDispatched,\n        on_scene: totalOnScene,\n        total: totalUnits\n      }\n    });\n  } catch (error) {\n    console.error('Get unit stats error:', error);\n    return NextResponse.json(\n      { error: 'Internal server error', details: error instanceof Error ? error.message : 'Unknown error' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}