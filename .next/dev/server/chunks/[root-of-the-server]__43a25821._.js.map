{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/leonliu/projects/tartanhacks/app/api/weather/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\n\nexport async function GET(request: Request) {\n  const { searchParams } = new URL(request.url);\n  const lat = searchParams.get('lat');\n  const lon = searchParams.get('lon');\n\n  if (!lat || !lon) {\n    console.error('Weather API: Missing parameters', { lat, lon });\n    return NextResponse.json(\n      { error: 'Missing latitude or longitude' },\n      { status: 400 }\n    );\n  }\n\n  // Validate coordinates\n  const latitude = parseFloat(lat);\n  const longitude = parseFloat(lon);\n  \n  if (isNaN(latitude) || isNaN(longitude) || latitude < -90 || latitude > 90 || longitude < -180 || longitude > 180) {\n    console.error('Weather API: Invalid coordinates', { lat, lon });\n    return NextResponse.json(\n      { error: 'Invalid latitude or longitude values' },\n      { status: 400 }\n    );\n  }\n\n  try {\n    console.log(`Weather API: Fetching data for coordinates: ${lat}, ${lon}`);\n    \n    // Using Open-Meteo API (free, no API key required)\n    // Fetching current weather with wind speed, direction, temperature, humidity, and visibility\n    const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,wind_direction_10m,visibility&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=auto`;\n    \n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout\n    \n    const weatherResponse = await fetch(weatherUrl, {\n      signal: controller.signal,\n      next: { revalidate: 300 }, // Cache for 5 minutes\n      headers: {\n        'Accept': 'application/json',\n      },\n    }).finally(() => clearTimeout(timeoutId));\n\n    if (!weatherResponse.ok) {\n      const errorText = await weatherResponse.text();\n      console.error(`Weather API error: ${weatherResponse.status} ${weatherResponse.statusText}`, errorText);\n      throw new Error(`Open-Meteo API returned ${weatherResponse.status}: ${errorText}`);\n    }\n\n    const weatherData = await weatherResponse.json();\n    \n    if (!weatherData.current) {\n      console.error('Weather API: Missing current data in response', weatherData);\n      throw new Error('Invalid weather data structure received');\n    }\n    \n    const current = weatherData.current;\n\n    // Fetch Air Quality data from Open-Meteo Air Quality API (non-blocking)\n    let airQuality = null;\n    try {\n      const airQualityUrl = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=us_aqi,pm2_5,pm10&timezone=auto`;\n      \n      const aqController = new AbortController();\n      const aqTimeoutId = setTimeout(() => aqController.abort(), 5000); // 5 second timeout for air quality\n      \n      const airQualityResponse = await fetch(airQualityUrl, {\n        signal: aqController.signal,\n        next: { revalidate: 300 }, // Cache for 5 minutes\n        headers: {\n          'Accept': 'application/json',\n        },\n      }).finally(() => clearTimeout(aqTimeoutId));\n\n      if (airQualityResponse.ok) {\n        const airQualityData = await airQualityResponse.json();\n        if (airQualityData.current) {\n          airQuality = {\n            aqi: airQualityData.current.us_aqi || null,\n            pm2_5: airQualityData.current.pm2_5 || null,\n            pm10: airQualityData.current.pm10 || null,\n          };\n        }\n      } else {\n        console.warn('Air Quality API failed (non-critical):', airQualityResponse.status);\n      }\n    } catch (airQualityError) {\n      console.warn('Air Quality API error (non-critical):', airQualityError);\n      // Continue without air quality data\n    }\n\n    // Extract relevant weather information\n    const completeWeatherData = {\n      wind: {\n        speed: Math.round(current.wind_speed_10m || 0), // mph\n        deg: current.wind_direction_10m || 0, // degrees\n        direction: getWindDirection(current.wind_direction_10m || 0),\n      },\n      temp: Math.round(current.temperature_2m || 0), // Fahrenheit\n      humidity: current.relative_humidity_2m || 0, // percentage\n      visibility: current.visibility ? Math.round(current.visibility / 1609.34) : null, // Convert meters to miles\n      airQuality: airQuality,\n      description: getWeatherDescription(current.weather_code || 0),\n      location: 'Current Location',\n    };\n\n    console.log('Weather API: Successfully fetched data', { temp: completeWeatherData.temp, humidity: completeWeatherData.humidity });\n    return NextResponse.json(completeWeatherData);\n  } catch (error) {\n    const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n    \n    // Check if it's an abort error (timeout)\n    if (error instanceof Error && error.name === 'AbortError') {\n      console.error('Weather API timeout:', errorMessage);\n      return NextResponse.json(\n        { \n          error: 'Weather service timeout',\n          details: 'The weather service took too long to respond. Please try again.',\n        },\n        { status: 504 }\n      );\n    }\n    \n    console.error('Error fetching weather data:', errorMessage, error);\n    return NextResponse.json(\n      { \n        error: 'Failed to fetch weather data',\n        details: errorMessage,\n      },\n      { status: 500 }\n    );\n  }\n}\n\n// Helper function to convert wind degrees to cardinal direction\nfunction getWindDirection(degrees: number): string {\n  const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];\n  const index = Math.round(((degrees % 360) / 22.5));\n  return directions[index % 16];\n}\n\n// Helper function to convert Open-Meteo weather codes to descriptions\nfunction getWeatherDescription(code: number): string {\n  const weatherCodes: { [key: number]: string } = {\n    0: 'Clear sky',\n    1: 'Mainly clear',\n    2: 'Partly cloudy',\n    3: 'Overcast',\n    45: 'Foggy',\n    48: 'Depositing rime fog',\n    51: 'Light drizzle',\n    53: 'Moderate drizzle',\n    55: 'Dense drizzle',\n    61: 'Slight rain',\n    63: 'Moderate rain',\n    65: 'Heavy rain',\n    71: 'Slight snow',\n    73: 'Moderate snow',\n    75: 'Heavy snow',\n    77: 'Snow grains',\n    80: 'Slight rain showers',\n    81: 'Moderate rain showers',\n    82: 'Violent rain showers',\n    85: 'Slight snow showers',\n    86: 'Heavy snow showers',\n    95: 'Thunderstorm',\n    96: 'Thunderstorm with slight hail',\n    99: 'Thunderstorm with heavy hail',\n  };\n  return weatherCodes[code] || 'Unknown';\n}\n\n"],"names":[],"mappings":"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","debugId":null}}]
}