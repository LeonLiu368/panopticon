{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 166, "column": 0}, "map": {"version":3,"sources":["file:///Users/leonliu/projects/tartanhacks/lib/composio-telegram-service.ts"],"sourcesContent":["import { Composio } from 'composio-core';\n\n// Initialize Composio client\nfunction getComposioClient() {\n  const apiKey = process.env.COMPOSIO_API_KEY;\n  \n  if (!apiKey) {\n    console.error('Composio API key missing');\n    throw new Error('Missing Composio API key. Please set COMPOSIO_API_KEY in your environment variables.');\n  }\n  \n  return new Composio(apiKey);\n}\n\nexport interface PoliceIncident {\n  id: string;\n  name: string | null;\n  priority: 'low' | 'medium' | 'high' | 'critical' | null;\n  lat: number | null;\n  lon: number | null;\n  containment: number | null;\n  last_update: string;\n  description?: string | null;\n  incident_type?: string | null;\n}\n\n// Keep FireIncident for backward compatibility\nexport type FireIncident = PoliceIncident;\n\nexport interface TelegramMessageOptions {\n  chatId: string;\n  incident: PoliceIncident | FireIncident;\n  customMessage?: string;\n}\n\n/**\n * Generate emergency alert message for police incident (Telegram formatted)\n */\nexport function generatePoliceAlertMessageTelegram(incident: PoliceIncident | FireIncident, customMessage?: string): string {\n  if (customMessage) {\n    return customMessage;\n  }\n\n  // Support both 'risk' (fire) and 'priority' (police) fields\n  const priorityLevel = (incident as any).priority || (incident as any).risk || 'unknown';\n  const incidentName = incident.name || 'Unnamed Incident';\n  const containment = incident.containment || 0;\n  const incidentType = (incident as PoliceIncident).incident_type || 'incident';\n  const coordinates = incident.lat && incident.lon \n    ? `${incident.lat.toFixed(2)}Â°N, ${Math.abs(incident.lon).toFixed(2)}Â°W`\n    : 'Location TBD';\n  \n  const timestamp = new Date(incident.last_update).toLocaleString('en-US', {\n    timeZone: 'America/Los_Angeles',\n    month: 'short',\n    day: 'numeric',\n    hour: '2-digit',\n    minute: '2-digit'\n  });\n\n  // Get priority emoji\n  const priorityEmoji = \n    priorityLevel === 'critical' ? 'ðŸš¨ðŸš¨' :\n    priorityLevel === 'high' ? 'ðŸš¨âš ï¸' :\n    priorityLevel === 'medium' ? 'âš ï¸ðŸš¨' :\n    'ðŸŸ¡';\n\n  // Get urgency message based on priority\n  const urgencyMessage =\n    priorityLevel === 'critical' ? 'âš ï¸ *CRITICAL ALERT* - Immediate response required!' :\n    priorityLevel === 'high' ? 'âš ï¸ *HIGH PRIORITY* - Rapid response needed!' :\n    priorityLevel === 'medium' ? 'âš ï¸ Medium priority - Standard response' :\n    'â„¹ï¸ Low priority - Routine response';\n\n  // Format with Telegram markdown\n  return `${priorityEmoji} *POLICE DISPATCH ALERT*\n\n${urgencyMessage}\n\nðŸš¨ *Active Police Incident*\n\n*Incident:* ${incidentName}\n*Type:* ${incidentType}\n*Priority:* ${priorityLevel.toUpperCase()}\n*Location:* ${coordinates}\n*Status:* ${containment > 0 ? `${containment}% resolved` : 'Active'}\n\n${incident.description ? `\\nðŸ“‹ *Details:* ${incident.description}\\n` : ''}\nðŸš“ *Police Dispatch Control Center*\nðŸ“ž Units responding - Avoid area if possible`;\n}\n\n// Keep old function name for backward compatibility\nexport const generateFireAlertMessageTelegram = generatePoliceAlertMessageTelegram;\n\n/**\n * Send Telegram message using Composio\n */\nexport async function sendTelegramMessage(options: TelegramMessageOptions): Promise<{\n  success: boolean;\n  messageId?: string;\n  error?: string;\n}> {\n  try {\n    // Log environment variable status for debugging\n    console.log('Composio Telegram Environment Variables Check:', {\n      hasComposioApiKey: !!process.env.COMPOSIO_API_KEY,\n      hasTelegramBotToken: !!process.env.TELEGRAM_BOT_TOKEN,\n      hasTelegramChatId: !!process.env.TELEGRAM_CHAT_ID,\n    });\n\n    // Validate required environment variables\n    if (!process.env.COMPOSIO_API_KEY) {\n      throw new Error('Missing COMPOSIO_API_KEY. Please set it in your environment variables.');\n    }\n\n    if (!process.env.TELEGRAM_BOT_TOKEN) {\n      throw new Error('Missing TELEGRAM_BOT_TOKEN. Please create a bot with @BotFather on Telegram.');\n    }\n\n    // Generate the alert message with Telegram formatting\n    const message = generatePoliceAlertMessageTelegram(options.incident, options.customMessage);\n\n    // For now, let's use the Telegram Bot API directly since Composio entity is having issues\n    // This bypasses Composio and uses direct Telegram API\n    const botToken = process.env.TELEGRAM_BOT_TOKEN;\n    \n    if (!botToken) {\n      throw new Error('Missing TELEGRAM_BOT_TOKEN');\n    }\n\n    console.log('Sending Telegram message directly via Bot API...', {\n      chatId: options.chatId,\n      messageLength: message.length,\n    });\n\n    // Send directly to Telegram Bot API\n    const telegramApiUrl = `https://api.telegram.org/bot${botToken}/sendMessage`;\n    \n    const response = await fetch(telegramApiUrl, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        chat_id: options.chatId,\n        text: message,\n        parse_mode: 'Markdown',\n      }),\n    });\n\n    const result = await response.json();\n    \n    if (!response.ok || !result.ok) {\n      throw new Error(`Telegram API error: ${result.description || 'Unknown error'}`);\n    }\n\n    console.log('Telegram message sent successfully:', result);\n    \n    return {\n      success: true,\n      messageId: result?.result?.message_id?.toString() || 'success',\n    };\n  } catch (error) {\n    console.error('Failed to send Telegram message via Composio:', error);\n    \n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Unknown error occurred',\n    };\n  }\n}\n\n/**\n * Send emergency alert to configured Telegram chat using Composio\n */\nexport async function sendEmergencyAlertViaTelegram(\n  incident: PoliceIncident | FireIncident, \n  customMessage?: string\n): Promise<{\n  success: boolean;\n  messageId?: string;\n  error?: string;\n}> {\n  // Get Telegram chat ID from env (your user ID or group chat ID)\n  const chatId = process.env.TELEGRAM_CHAT_ID;\n  \n  if (!chatId) {\n    return {\n      success: false,\n      error: 'TELEGRAM_CHAT_ID not configured. Please set it in your environment variables.',\n    };\n  }\n  \n  return sendTelegramMessage({\n    chatId,\n    incident,\n    customMessage,\n  });\n}\n\n/**\n * Send alert to multiple Telegram chats (optional - for future use)\n */\nexport async function sendEmergencyAlertToMultipleChats(\n  incident: PoliceIncident | FireIncident,\n  chatIds: string[],\n  customMessage?: string\n): Promise<{\n  success: boolean;\n  results: Array<{ chatId: string; success: boolean; messageId?: string; error?: string }>;\n}> {\n  const results = await Promise.all(\n    chatIds.map(async (chatId) => {\n      const result = await sendTelegramMessage({ chatId, incident, customMessage });\n      return { chatId, ...result };\n    })\n  );\n\n  const allSuccess = results.every((r) => r.success);\n\n  return {\n    success: allSuccess,\n    results,\n  };\n}\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 322, "column": 0}, "map": {"version":3,"sources":["file:///Users/leonliu/projects/tartanhacks/app/api/send-emergency-alert/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { sendEmergencyAlertViaTelegram, PoliceIncident, FireIncident } from '@/lib/composio-telegram-service';\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { incident, customMessage } = body;\n\n    // Validate required fields\n    if (!incident) {\n      return NextResponse.json(\n        { success: false, error: 'Incident data is required' },\n        { status: 400 }\n      );\n    }\n\n    // Validate incident structure - support both 'risk' (fire) and 'priority' (police)\n    const requiredFields = ['id', 'name', 'lat', 'lon', 'last_update'];\n    const hasPriority = incident.priority || incident.risk;\n    const missingFields = requiredFields.filter(field => !incident[field]);\n    \n    if (missingFields.length > 0 || !hasPriority) {\n      return NextResponse.json(\n        { \n          success: false, \n          error: `Missing required fields: ${missingFields.join(', ')}${!hasPriority ? ', priority/risk' : ''}` \n        },\n        { status: 400 }\n      );\n    }\n\n    // Send the emergency alert via Composio + Telegram\n    const result = await sendEmergencyAlertViaTelegram(incident as PoliceIncident | FireIncident, customMessage);\n\n    if (result.success) {\n      return NextResponse.json({\n        success: true,\n        messageSid: result.messageId,\n        message: 'Emergency alert sent successfully via Telegram'\n      });\n    } else {\n      return NextResponse.json(\n        { \n          success: false, \n          error: result.error || 'Failed to send emergency alert' \n        },\n        { status: 500 }\n      );\n    }\n  } catch (error) {\n    console.error('API Error:', error);\n    return NextResponse.json(\n      { \n        success: false, \n        error: 'Internal server error' \n      },\n      { status: 500 }\n    );\n  }\n}\n\n// Handle unsupported methods\nexport async function GET() {\n  return NextResponse.json(\n    { error: 'Method not allowed. Use POST to send emergency alerts.' },\n    { status: 405 }\n  );\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,QAAQ,EAAE,aAAa,EAAE,GAAG;QAEpC,2BAA2B;QAC3B,IAAI,CAAC,UAAU;YACb,OAAO,2KAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,OAAO;YAA4B,GACrD;gBAAE,QAAQ;YAAI;QAElB;QAEA,mFAAmF;QACnF,MAAM,iBAAiB;YAAC;YAAM;YAAQ;YAAO;YAAO;SAAc;QAClE,MAAM,cAAc,SAAS,QAAQ,IAAI,SAAS,IAAI;QACtD,MAAM,gBAAgB,eAAe,MAAM,CAAC,CAAA,QAAS,CAAC,QAAQ,CAAC,MAAM;QAErE,IAAI,cAAc,MAAM,GAAG,KAAK,CAAC,aAAa;YAC5C,OAAO,2KAAY,CAAC,IAAI,CACtB;gBACE,SAAS;gBACT,OAAO,CAAC,yBAAyB,EAAE,cAAc,IAAI,CAAC,QAAQ,CAAC,cAAc,oBAAoB,IAAI;YACvG,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,mDAAmD;QACnD,MAAM,SAAS,MAAM,IAAA,oMAA6B,EAAC,UAA2C;QAE9F,IAAI,OAAO,OAAO,EAAE;YAClB,OAAO,2KAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,YAAY,OAAO,SAAS;gBAC5B,SAAS;YACX;QACF,OAAO;YACL,OAAO,2KAAY,CAAC,IAAI,CACtB;gBACE,SAAS;gBACT,OAAO,OAAO,KAAK,IAAI;YACzB,GACA;gBAAE,QAAQ;YAAI;QAElB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,cAAc;QAC5B,OAAO,2KAAY,CAAC,IAAI,CACtB;YACE,SAAS;YACT,OAAO;QACT,GACA;YAAE,QAAQ;QAAI;IAElB;AACF;AAGO,eAAe;IACpB,OAAO,2KAAY,CAAC,IAAI,CACtB;QAAE,OAAO;IAAyD,GAClE;QAAE,QAAQ;IAAI;AAElB","debugId":null}}]
}